<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quản lý tour Như Huỳnh</title>
<style>
  body{margin:0;font-family:sans-serif;background:#f6f7fb;color:#111}
  header{padding:20px;background:#fff;box-shadow:0 2px 12px rgba(0,0,0,.06);position:sticky;top:0;z-index:10;display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between}
  h1{margin:0;font-size:18px}
  .wrap{max-width:1100px;margin:20px auto;padding:0 16px}
  form{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;background:#fff;padding:14px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.05)}
  input,button,textarea{padding:10px;border:1px solid #ddd;border-radius:10px;font-size:14px}
  button{cursor:pointer;background:#4f46e5;color:#fff;border:none}
  button.danger{background:#e54d4d}
  table{width:100%;border-collapse:collapse;margin-top:14px;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.05)}
  th,td{padding:10px;border-bottom:1px solid #eee;font-size:14px;text-align:left}
  th{background:#fafafa}
  tr:hover{background:#f9f9ff}
  .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin:18px 0}
  .card{background:#fff;padding:14px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.05)}
  .card h3{margin:0;font-size:15px;color:#666}
  .card p{margin:6px 0 0;font-weight:bold;font-size:18px}
  #editPanel{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center}
  #editPanel .inner{background:#fff;padding:20px;border-radius:12px;width:90%;max-width:400px;display:grid;gap:10px}
</style>
</head>
<body>
<header>
  <h1>Quản lý tour Như Huỳnh</h1>
  <div>
    Ngày: <input type="date" id="datePicker" />
    <span id="dayTotal" style="margin-left:10px;background:#f3f4f6;padding:6px 10px;border-radius:8px">Tổng ngày này: 0 đ</span>
  </div>
</header>
<div class="wrap">
  <div class="cards">
    <div class="card"><h3>Hôm nay</h3><p id="todaySum">0 đ</p></div>
    <div class="card"><h3>Hôm qua</h3><p id="yesterdaySum">0 đ</p></div>
    <div class="card"><h3>Tuần này</h3><p id="weekSum">0 đ</p></div>
    <div class="card"><h3>Tháng này</h3><p id="monthSum">0 đ</p></div>
  </div>

  <form id="addForm">
    <input id="name" placeholder="Tên khách hàng *" required />
    <input id="phone" placeholder="Số điện thoại (tùy chọn)" />
    <input id="service" placeholder="Loại dịch vụ *" required />
    <input id="price" placeholder="Giá tiền *" required type="number" />
    <input id="note" placeholder="Ghi chú" />
    <button type="submit">Thêm</button>
  </form>

  <div style="margin:12px 0;display:flex;gap:10px;flex-wrap:wrap">
    <input id="search" placeholder="Tìm theo tên / SĐT / dịch vụ..." style="flex:1" />
    <button id="export">Xuất CSV</button>
    <button id="clear" class="danger">Xóa tất cả (ngày này)</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>#</th><th>Tên KH</th><th>SĐT</th><th>Dịch vụ</th><th>Giá tiền</th><th>Ghi chú</th><th>Thời gian</th><th>Hành động</th>
      </tr>
    </thead>
    <tbody id="tbody"><tr><td colspan="8">Chưa có dữ liệu</td></tr></tbody>
  </table>
</div>

<!-- Panel sửa -->
<div id="editPanel">
  <div class="inner">
    <h3>Sửa thông tin</h3>
    <input id="editName" />
    <input id="editPhone" />
    <input id="editService" />
    <input id="editPrice" type="number" />
    <input id="editNote" />
    <div style="display:flex;gap:10px;justify-content:flex-end">
      <button id="saveEdit">Lưu</button>
      <button type="button" onclick="closeEdit()">Hủy</button>
    </div>
  </div>
</div>

<script>
let rows=[], editIndex=null;

function formatMoney(n){return n.toLocaleString("vi-VN")+" đ";}
function getKey(d){return "spaTourRows_"+d;}
function todayStr(){return new Date().toISOString().slice(0,10);}

function loadRows(){
  const d=document.getElementById("datePicker").value;
  rows=JSON.parse(localStorage.getItem(getKey(d))||"[]");
}
function saveRows(){
  const d=document.getElementById("datePicker").value;
  localStorage.setItem(getKey(d),JSON.stringify(rows));
  updateDashboard();
}
function render(){
  const tb=document.getElementById("tbody");tb.innerHTML="";
  const q=document.getElementById("search").value.toLowerCase();
  let filtered=rows.filter(r=>(r.name+" "+r.phone+" "+r.service).toLowerCase().includes(q));
  if(!filtered.length){tb.innerHTML="<tr><td colspan=8>Chưa có dữ liệu</td></tr>";return;}
  filtered.forEach((r,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${i+1}</td><td>${r.name}</td><td>${r.phone||""}</td><td>${r.service}</td>
                  <td>${formatMoney(r.price)}</td><td>${r.note||""}</td><td>${r.time}</td>
                  <td><button onclick="openEdit(${i})">Sửa</button> <button onclick="del(${i})">Xóa</button></td>`;
    tb.appendChild(tr);
  });
  document.getElementById("dayTotal").textContent="Tổng ngày này: "+formatMoney(rows.reduce((a,b)=>a+b.price,0));
}
function updateDashboard(){
  const today=new Date(document.getElementById("datePicker").value);
  const todayKey=getKey(today.toISOString().slice(0,10));
  const yesterday=new Date(today);yesterday.setDate(yesterday.getDate()-1);
  const yKey=getKey(yesterday.toISOString().slice(0,10));

  function sum(key){return (JSON.parse(localStorage.getItem(key)||"[]")).reduce((a,b)=>a+b.price,0);}

  document.getElementById("todaySum").textContent=formatMoney(sum(todayKey));
  document.getElementById("yesterdaySum").textContent=formatMoney(sum(yKey));

  // Tuần này
  let weekSum=0;
  for(let i=0;i<7;i++){let d=new Date(today);d.setDate(today.getDate()-i);
    weekSum+=sum(getKey(d.toISOString().slice(0,10)));
  }
  document.getElementById("weekSum").textContent=formatMoney(weekSum);

  // Tháng này
  let monthSum=0;for(let i=0;i<31;i++){let d=new Date(today);d.setDate(today.getDate()-i);
    if(d.getMonth()!==today.getMonth()) break;
    monthSum+=sum(getKey(d.toISOString().slice(0,10)));
  }
  document.getElementById("monthSum").textContent=formatMoney(monthSum);
}

document.getElementById("addForm").onsubmit=e=>{
  e.preventDefault();
  const name=document.getElementById("name").value.trim();
  const phone=document.getElementById("phone").value.trim();
  const service=document.getElementById("service").value.trim();
  const price=parseFloat(document.getElementById("price").value)||0;
  const note=document.getElementById("note").value.trim();
  if(!name||!service||!price){alert("Vui lòng nhập đủ tên, dịch vụ, giá");return;}
  rows.push({name,phone,service,price,note,time:new Date().toLocaleTimeString()});
  saveRows();render();e.target.reset();
};

function del(i){if(confirm("Xóa mục này?")){rows.splice(i,1);saveRows();render();}}

document.getElementById("clear").onclick=()=>{if(confirm("Xóa tất cả?")){rows=[];saveRows();render();}};

document.getElementById("search").oninput=render;
document.getElementById("export").onclick=()=>{
  if(!rows.length){alert("Không có dữ liệu");return;}
  let csv="Tên,SDT,Dịch vụ,Giá tiền,Ghi chú,Thời gian\n";
  rows.forEach(r=>{csv+=`${r.name},${r.phone},${r.service},${r.price},${r.note||""},${r.time}\n`;});
  const blob=new Blob([csv],{type:"text/csv"});const url=URL.createObjectURL(blob);
  const a=document.createElement("a");a.href=url;a.download="data.csv";a.click();URL.revokeObjectURL(url);
};

function openEdit(i){editIndex=i;const r=rows[i];
  document.getElementById("editName").value=r.name;
  document.getElementById("editPhone").value=r.phone;
  document.getElementById("editService").value=r.service;
  document.getElementById("editPrice").value=r.price;
  document.getElementById("editNote").value=r.note||"";
  document.getElementById("editPanel").style.display="flex";
}
function closeEdit(){document.getElementById("editPanel").style.display="none";}
document.getElementById("saveEdit").onclick=()=>{
  const r=rows[editIndex];
  r.name=document.getElementById("editName").value.trim();
  r.phone=document.getElementById("editPhone").value.trim();
  r.service=document.getElementById("editService").value.trim();
  r.price=parseFloat(document.getElementById("editPrice").value)||0;
  r.note=document.getElementById("editNote").value.trim();
  saveRows();render();closeEdit();
};

document.getElementById("datePicker").value=todayStr();
document.getElementById("datePicker").onchange=()=>{loadRows();render();};
loadRows();render();updateDashboard();
</script>
</body>
</html>
