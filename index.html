<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Qu·∫£n l√Ω tour Nh∆∞ Hu·ª≥nh</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f7f9fc; }
    h2 { margin-bottom: 10px; }
    .dashboard { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
    .card { flex: 1; min-width: 180px; background: #fff; padding: 15px; border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1); text-align: center; }
    .card h3 { margin: 0; font-size: 18px; color: #333; }
    .card p { font-size: 20px; font-weight: bold; color: #007bff; }
    .form-group { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
    input { padding: 8px; border: 1px solid #ccc; border-radius: 6px; flex: 1; }
    button { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; }
    .btn-add { background: #4e6ef2; color: white; }
    .btn-del { background: #e74c3c; color: white; }
    .btn-edit { background: #f39c12; color: white; }
    table { width: 100%; border-collapse: collapse; background: white; }
    th, td { padding: 10px; border: 1px solid #ddd; text-align: center; }
    th { background: #f1f1f1; }
    .edit-panel {
      display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 999; width: 320px;
    }
    .overlay { display: none; position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.4); z-index: 998; }
  </style>
</head>
<body>
  <h2>Qu·∫£n l√Ω tour Nh∆∞ Hu·ª≥nh</h2>

  <!-- Dashboard -->
  <div class="dashboard">
    <div class="card"><h3>H√¥m nay</h3><p id="todayTotal">0 ƒë</p></div>
    <div class="card"><h3>H√¥m qua</h3><p id="yesterdayTotal">0 ƒë</p></div>
    <div class="card"><h3>Tu·∫ßn n√†y</h3><p id="weekTotal">0 ƒë</p></div>
    <div class="card"><h3>Th√°ng n√†y</h3><p id="monthTotal">0 ƒë</p></div>
  </div>

  <!-- Form -->
  <div class="form-group">
    <input id="name" placeholder="T√™n kh√°ch h√†ng *">
    <input id="phone" placeholder="S·ªë ƒëi·ªán tho·∫°i (t√πy ch·ªçn)">
    <input id="service" placeholder="Lo·∫°i d·ªãch v·ª• *">
    <input id="price" type="number" placeholder="Gi√° ti·ªÅn *">
    <input id="note" placeholder="Ghi ch√∫">
    <button class="btn-add" onclick="addTour()">Th√™m</button>
  </div>

  <!-- Table -->
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>T√™n KH</th>
        <th>SDT</th>
        <th>D·ªãch v·ª•</th>
        <th>Gi√° ti·ªÅn</th>
        <th>Ghi ch√∫</th>
        <th>Ng√†y</th>
        <th>H√†nh ƒë·ªông</th>
      </tr>
    </thead>
    <tbody id="tourTable"><tr><td colspan="8">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr></tbody>
  </table>

  <!-- Edit Panel -->
  <div class="overlay" id="overlay"></div>
  <div class="edit-panel" id="editPanel">
    <h3>S·ª≠a th√¥ng tin tour</h3>
    <input id="editName" placeholder="T√™n kh√°ch h√†ng">
    <input id="editPhone" placeholder="S·ªë ƒëi·ªán tho·∫°i">
    <input id="editService" placeholder="D·ªãch v·ª•">
    <input id="editPrice" type="number" placeholder="Gi√° ti·ªÅn">
    <input id="editNote" placeholder="Ghi ch√∫">
    <button class="btn-add" onclick="saveEdit()">L∆∞u</button>
    <button class="btn-del" onclick="closeEdit()">H·ªßy</button>
  </div>

  <!-- Firebase + App Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, where } 
      from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // üî• Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCUl6KMtiZZdqHPCp6SYVIAp6BTAfUJx2I",
      authDomain: "tour-manager-faa53.firebaseapp.com",
      projectId: "tour-manager-faa53",
      storageBucket: "tour-manager-faa53.appspot.com",
      messagingSenderId: "897754227514",
      appId: "1:897754227514:web:3f57ebcefea47a35e6a603"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const table = document.getElementById("tourTable");
    let editId = null;

    // üìå Th√™m tour
    async function addTour() {
      let name = document.getElementById("name").value.trim();
      let phone = document.getElementById("phone").value.trim();
      let service = document.getElementById("service").value.trim();
      let price = document.getElementById("price").value.trim();
      let note = document.getElementById("note").value.trim();

      if (!name || !service || !price) {
        alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!");
        return;
      }

      let today = new Date().toISOString().split("T")[0];
      await addDoc(collection(db, "tours"), { name, phone, service, price: Number(price), note, date: today });

      document.getElementById("name").value = "";
      document.getElementById("phone").value = "";
      document.getElementById("service").value = "";
      document.getElementById("price").value = "";
      document.getElementById("note").value = "";

      loadTours();
    }

    // üìå Hi·ªÉn th·ªã tour
    async function loadTours() {
      const snapshot = await getDocs(collection(db, "tours"));
      let data = [];
      snapshot.forEach(docSnap => {
        data.push({ id: docSnap.id, ...docSnap.data() });
      });

      if (data.length === 0) {
        table.innerHTML = "<tr><td colspan='8'>Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>";
        return;
      }

      let html = "";
      data.forEach((t, i) => {
        html += `<tr>
          <td>${i+1}</td>
          <td>${t.name}</td>
          <td>${t.phone || ""}</td>
          <td>${t.service}</td>
          <td>${t.price.toLocaleString()} ƒë</td>
          <td>${t.note || ""}</td>
          <td>${t.date}</td>
          <td>
            <button class="btn-edit" onclick="openEdit('${t.id}','${t.name}','${t.phone || ""}','${t.service}','${t.price}','${t.note || ""}')">S·ª≠a</button>
            <button class="btn-del" onclick="deleteTour('${t.id}')">X√≥a</button>
          </td>
        </tr>`;
      });
      table.innerHTML = html;

      updateDashboard(data);
    }

    // üìå X√≥a tour
    async function deleteTour(id) {
      if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a?")) {
        await deleteDoc(doc(db, "tours", id));
        loadTours();
      }
    }

    // üìå M·ªü panel s·ª≠a
    window.openEdit = function(id, name, phone, service, price, note) {
      editId = id;
      document.getElementById("editName").value = name;
      document.getElementById("editPhone").value = phone;
      document.getElementById("editService").value = service;
      document.getElementById("editPrice").value = price;
      document.getElementById("editNote").value = note;
      document.getElementById("editPanel").style.display = "block";
      document.getElementById("overlay").style.display = "block";
    };

    // üìå ƒê√≥ng panel
    window.closeEdit = function() {
      document.getElementById("editPanel").style.display = "none";
      document.getElementById("overlay").style.display = "none";
    };

    // üìå L∆∞u ch·ªânh s·ª≠a
    window.saveEdit = async function() {
      let name = document.getElementById("editName").value.trim();
      let phone = document.getElementById("editPhone").value.trim();
      let service = document.getElementById("editService").value.trim();
      let price = Number(document.getElementById("editPrice").value.trim());
      let note = document.getElementById("editNote").value.trim();

      await updateDoc(doc(db, "tours", editId), { name, phone, service, price, note });
      closeEdit();
      loadTours();
    };

    // üìå Dashboard
    function updateDashboard(data) {
      let today = new Date().toISOString().split("T")[0];
      let yesterday = new Date(Date.now() - 86400000).toISOString().split("T")[0];
      let weekStart = new Date(); weekStart.setDate(weekStart.getDate() - weekStart.getDay());
      let monthStart = new Date(); monthStart.setDate(1);

      let todayTotal = data.filter(t=>t.date===today).reduce((s,t)=>s+t.price,0);
      let yesterdayTotal = data.filter(t=>t.date===yesterday).reduce((s,t)=>s+t.price,0);
      let weekTotal = data.filter(t=>new Date(t.date)>=weekStart).reduce((s,t)=>s+t.price,0);
      let monthTotal = data.filter(t=>new Date(t.date)>=monthStart).reduce((s,t)=>s+t.price,0);

      document.getElementById("todayTotal").innerText = todayTotal.toLocaleString()+" ƒë";
      document.getElementById("yesterdayTotal").innerText = yesterdayTotal.toLocaleString()+" ƒë";
      document.getElementById("weekTotal").innerText = weekTotal.toLocaleString()+" ƒë";
      document.getElementById("monthTotal").innerText = monthTotal.toLocaleString()+" ƒë";
    }

    // üöÄ Load ban ƒë·∫ßu
    loadTours();
    window.addTour = addTour;
    window.deleteTour = deleteTour;
  </script>
</body>
</html>
